# Lab: Debugging and Observability with Inspektor Gadget

## Overview

Inpsektor Gadget has powerful set of gadgets that can be used to troubleshoot and debug issues in your Kubernetes cluster. This lab will focus on highlighting some of the key gadgets 
and different ways to use them to troubleshoot issues in your cluster.

### Task 1: Troubleshooting DNS Issues

DNS is a critical component in a Kubernetes cluster as it is used by various components to communicate with each other. In this lab, we will look at how to troubleshoot DNS issues in a Kubernetes cluster.

#### Step 1: Create a new namespace

Start by creating a new namespace called `dns-debug`:

```bash
kubectl create ns dns-debug
```

#### Step 2: Deploy a pod in the `dns-debug` namespace

```bash
kubectl -n dns-debug run mypod --image=wbitt/network-multitool -- sleep inf
```

#### Step 3: Start the DNS gadget

```bash
kubectl gadget run trace_dns:v0.38.1 -n dns-debug --fields src,dst,name,qr,rcode
```

#### Step 4: Generate DNS traffic

Inside the pod, run the following command to generate DNS traffic:

```bash
kubectl -n dns-debug exec mypod -- sh -c "nslookup kubernetes.default.svc.cluster.local."
```

#### Step 5: View the DNS traffic

You should see the DNS traffic generated by the `nslookup` by visiting the terminal where the DNS gadget was started.

```bash
SRC                                                  DST                                                  NAME                                                                                 QR    RCODE                 
p/dns-debug/mypod:39376                              s/kube-system/kube-dns:53                            kubernetes.default.svc.cluster.local.                                                Q                           
s/kube-system/kube-dns:53                            p/dns-debug/mypod:39376                              kubernetes.default.svc.cluster.local.                                                R     Success               
s/kube-system/kube-dns:53                            p/dns-debug/mypod:50322                              kubernetes.default.svc.cluster.local.                                                R     Success               
p/dns-debug/mypod:50322                              s/kube-system/kube-dns:53                            kubernetes.default.svc.cluster.local.                                                Q                   
```

### Challenge: 

Try to filter the DNS response by using the `--filter` option. Hint: You can use `kubectl gadget run trace_dns:v0.38.1 -h` to see the how to use the `--filter` option and what `--fields`  are available to filter on.

<details>
<summary>Solution</summary>

```bash
kubectl gadget run trace_dns:v0.38.1 -n dns-debug --fields src,dst,name,qr,rcode --filter qr=R
```
</details>

#### Step 6: Clean up

```bash
kubectl delete ns dns-debug
```

### Task 2: Troubleshooting TCP Connections

TCP connections are used by various components in a Kubernetes cluster to communicate with each other. In this lab, we will look at how to troubleshoot TCP connections in a Kubernetes cluster.

#### Step 1: Create a new namespace

```bash
kubectl create ns tcp-debug
```

#### Step 2: Deploy a server pod in the `tcp-debug` namespace

```bash
kubectl run iperf-server-1 -n tcp-debug --image=networkstatic/iperf3 --restart=Never --command -- iperf3 -s
kubectl run iperf-server-2 -n tcp-debug --image=networkstatic/iperf3 --restart=Never --command -- iperf3 -s
kubectl run iperf-server-3 -n tcp-debug --image=networkstatic/iperf3 --restart=Never --command -- iperf3 -s
```

#### Step 3: Expose the server pod

```bash
kubectl expose pod iperf-server-1 -n tcp-debug --port=5201
kubectl expose pod iperf-server-2 -n tcp-debug --port=5201
kubectl expose pod iperf-server-3 -n tcp-debug --port=5201
```

#### Step 3: Deploy a client pod with different load in the `tcp-debug` namespace

```bash
kubectl run iperf-client-high -n tcp-debug --image=networkstatic/iperf3 --restart=Never --command -- iperf3 -c iperf-server-1.tcp-debug.svc.cluster.local -t 600 -b 100M
kubectl run iperf-client-medium -n tcp-debug --image=networkstatic/iperf3 --restart=Never --command -- iperf3 -c iperf-server-2.tcp-debug.svc.cluster.local -t 600 -b 20M
kubectl run iperf-client-low -n tcp-debug --image=networkstatic/iperf3 --restart=Never --command -- iperf3 -c iperf-server-3.tcp-debug.svc.cluster.local -t 600 -b 5M
```

#### Step 4: Start the TCP gadget

```bash
kubectl gadget run top_tcp:v0.38.1 -n tcp-debug
K8S.NODE                  K8S.NAMESPACE            K8S.PODNAME              K8S.CONTAINERNAME               PID        TID SRC                              DST                              COMM             SENT RECEIVED
minikube-docker           tcp-debug                iperf-server-1           iperf-server-1               697270     697270 p/tcp-debug/iperf-server-1:5201  p/tcp-debug/iperf-client-high:5… iperf3            0 B    12 MB
minikube-docker           tcp-debug                iperf-client-low         iperf-client-low             699188     699188 p/tcp-debug/iperf-client-low:57… s/tcp-debug/iperf-server-3:5201  iperf3         655 kB      0 B
minikube-docker           tcp-debug                iperf-client-medium      iperf-client-medium          698906     698906 p/tcp-debug/iperf-client-medium… s/tcp-debug/iperf-server-2:5201  iperf3         2.5 MB      0 B
minikube-docker           tcp-debug                iperf-client-high        iperf-client-high            698623     698623 p/tcp-debug/iperf-client-high:5… s/tcp-debug/iperf-server-1:5201  iperf3          12 MB      0 B
minikube-docker           tcp-debug                iperf-server-3           iperf-server-3               697847     697847 p/tcp-debug/iperf-server-3:5201  p/tcp-debug/iperf-client-low:57… iperf3            0 B   655 kB
minikube-docker           tcp-debug                iperf-server-2           iperf-server-2               697561     697561 p/tcp-debug/iperf-server-2:5201  p/tcp-debug/iperf-client-medium… iperf3            0 B   2.5 MB
```

#### Step 5: Clean up

```bash
kubectl delete ns tcp-debug
```